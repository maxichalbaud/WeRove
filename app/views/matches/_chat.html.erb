<div class="container">
  <div class="row">
    <div class="col-sm-6 col-sm-offset-3">
      <div class="chat-header">
        <div class="chat-avatar" style="display: flex; justify-content: space-between;">
        <h3 class="pr-2"><%= @matched_user.first_name %></h3>
          <% if @matched_user.photo.attached? %>
          <%= cl_image_tag @matched_user.photo.key, class: "avatar-bordered my-2" %>
          <% else %>
          <img src="" alt="" class="avatar-bordered my-2">
          <% end %>
        </div>
        <div class="messages">
          <% @match.messages.each do |message| %>
            <%= render "message", message: message %>
          <% end %>
        </div>
        <div id="create-message">
          <%= simple_form_for [ @match, Message.new ], remote: true do |f| %>
            <%= f.input :content, label: false %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

  <script>

    function scrollLastMessageIntoView() {
      const messages = document.querySelectorAll('.message');
      const lastMessage = messages[messages.length - 1];

      if (lastMessage !== undefined) {
        lastMessage.scrollIntoView();
      }
    }
    scrollLastMessageIntoView();

    setTimeout(function(){
      App['match_<%= @match.id %>'] = App.cable.subscriptions.create(
        { channel: 'MatchesChannel', match_id: <%= @match.id %> },
        {
          received: (data) => {
            if (data.current_user_id !== <%= current_user.id %>) {
              const messagesContainer = document.querySelector('.messages');
              messagesContainer.insertAdjacentHTML('beforeend', data.message_partial);
              scrollLastMessageIntoView();
            }
          }
        }
      )
    }, 2000);
  </script>
